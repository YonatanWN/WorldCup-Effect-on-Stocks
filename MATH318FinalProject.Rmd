---
title: "MATH 318 Final Project"
output: html_notebook
---

# MATH 318 Final Project

# Effect of World Cup on Stock Price and Trading Activity

```{r}
library(tidyverse)
library(dplyr)
library(MASS)
library(lubridate)
library(stringr)
```

```{r}
spydata = as_tibble(read.csv("1_min_SPY_2008-2021.csv"))

```

```{r}
worldcupmatches = as_tibble(read.csv("WorldCupMatches.csv"))
```

```{r}
spydata
```

```{r}
spydata$date = as.POSIXct(spydata$date, format="%Y%m%d %H:%M:%S")
spydata
```

```{r}
#Remove Rows containing NA's
cleaned_worldcupmatches = unique(worldcupmatches[!apply(is.na(worldcupmatches) | worldcupmatches == "", 1, all),])
#Convert Date and Time into POSIX EDT 
cleaned_worldcupmatches$Datetime = as.POSIXct(cleaned_worldcupmatches$Datetime, format = "%e %b %Y - %R") - 60* 60
cleaned_worldcupmatches
```

```{r}
worldcupmatches2014 = filter(cleaned_worldcupmatches, Year == 2014)
worldcupmatches2014
```

```{r}
startingdate = min(worldcupmatches2014$Datetime)
spyafterworldcup = filter(spydata,  date >= startingdate)
out <-spyafterworldcup[order(spyafterworldcup$date),]
out
```

```{r}
#Clean SpyData Per Game
getSpyDataWithinRangeofGame = function(spydata,game_date,range){
  rangeInSeconds = 60 * 60 * range
  return(filter(spydata, (date >= game_date - rangeInSeconds) & (date <= game_date + rangeInSeconds)))
}
```

```{r}
#Clean Spydata Per Worldcup Returns a set of spydata with their corresponding game data
getSpyAndGameDataWithinWorldcup = function(worldcup, spydata, range){
  z = getSpyDataWithinRangeofGame(spydata, worldcup[[1,"Datetime"]], range)
  gamerow = worldcup[1,]
  for(colIndx in 1: ncol(gamerow)){
      colvalue = worldcup[[1, colIndx]]
      colname = colnames(worldcup)[colIndx]
      z[colname] = rep(colvalue, times= nrow(z))
   }
  
  for(gameIndx in 2:nrow(worldcup)){
   x = getSpyDataWithinRangeofGame(spydata, worldcup[[gameIndx,"Datetime"]], range)
   gamerow = worldcup[gameIndx,]
   for(colIndx in 1: ncol(gamerow)){
      colvalue = worldcup[[gameIndx, colIndx]]
      colname = colnames(worldcup)[colIndx]
      x[colname] = rep(colvalue, times= nrow(x))
   }
   z = union_all(z,x)
  }
  return(z)
}
```

```{r}
getSpyAndGameDataForOneGame = function(spydata,worldcup, game_index, range){
  z = getSpyDataWithinRangeofGame(spydata, worldcup[[game_index,"Datetime"]], range)
  for(colIndx in 1: ncol(worldcup[game_index,])){
      colvalue = worldcup[[game_index, colIndx]]
      colname = colnames(worldcup)[colIndx]
      z[colname] = rep(colvalue, times= nrow(z))
  }
  z["Time_From_Game"] = z$date - rep(worldcup[[game_index,"Datetime"]], times = nrow(z))
  return(z)
}
```

```{r}
getSpyAndGameDataForOneGame(spydata, cleaned_worldcupmatches,2,3)
```

```{r}
getSpyDatawithinWorldcup(worldcupmatches2014, spydata, 3)
```

```{r}
getSpyDatawithinRangeofGame(spydata, worldcupmatches2014$Datetime[3], 3)
```
